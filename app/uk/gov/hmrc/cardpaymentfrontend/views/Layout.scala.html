@*
 * Copyright 2025 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import payapi.corcommon.model.Origin
@import uk.gov.hmrc.cardpaymentfrontend.config.AppConfig
@import uk.gov.hmrc.cardpaymentfrontend.models.extendedorigins.ExtendedOrigin.OriginExtended
@import uk.gov.hmrc.cardpaymentfrontend.requests.RequestSupport.isLoggedIn
@import uk.gov.hmrc.cardpaymentfrontend.views.helpers.TitleMaker.journeyTitleMaker
@import uk.gov.hmrc.govukfrontend.views.Aliases.BackLink
@import uk.gov.hmrc.hmrcfrontend.views.html.helpers.{HmrcReportTechnicalIssueHelper, HmrcStandardPage, HmrcTimeoutDialogHelper}
@import uk.gov.hmrc.hmrcfrontend.views.viewmodels.hmrcstandardpage.{HmrcStandardPageParams, ServiceURLs, TemplateOverrides}
@import views.html.helper.CSPNonce
@import payapi.corcommon.model.PaymentStatuses
@import payapi.cardpaymentjourney.model.journey.{Journey, JourneySpecificData}

@this(
        appConfig: AppConfig,
        hmrcReportTechnicalIssueHelper: HmrcReportTechnicalIssueHelper,
        hmrcStandardPage: HmrcStandardPage,
        hmrcTimeoutDialogHelper: HmrcTimeoutDialogHelper
)
@(
        pageTitle: Option[String] = None,
        origin: Option[Origin] = None,
        maybeForm: Option[Form[?]] = None,
        showBackLink: Boolean = true,
        journey: Option[Journey[JourneySpecificData]] = None,
        showTimeoutDialogue: Boolean = true,
        backLinkOverride: Option[BackLink] = None,
        welshSupported: Boolean = true,
        additionalScripts: Option[Html] = None,
        hideStyling: Boolean = false
)(contentBlock: Html)(implicit request: RequestHeader, messages: Messages)

@serviceName = @{origin.map(eo => messages(eo.lift(appConfig).serviceNameMessageKey)).getOrElse(messages("service-name.generic"))}

@serviceUrl = @{
    journey match {
        case Some(value) if value.origin.isAWebChatOrigin && value.status == PaymentStatuses.Successful =>
            Some(uk.gov.hmrc.cardpaymentfrontend.controllers.routes.PaymentCompleteController.renderPage.url)
        case Some(value) if value.origin.isAWebChatOrigin  => Some(appConfig.payFrontendWebchatLandingUrl)
        case Some(value)                                     => Some(appConfig.payFrontendBaseUrl)
        case None                                              => Some(appConfig.payFrontendBaseUrl)
    }
}

@welshSupportedForOrigin = @{ origin.exists(_.originSupportsWelsh )}

@headBlock = {
    @if(showTimeoutDialogue) {
        @hmrcTimeoutDialogHelper(
            signOutUrl =
                if(isLoggedIn) {
                    uk.gov.hmrc.cardpaymentfrontend.controllers.routes.SignOutController.signOut.url
                } else {
                    uk.gov.hmrc.cardpaymentfrontend.controllers.routes.TimeOutController.showForceDeleteAnswersLoggedOutPage.url
                },
            timeoutUrl =
                Some(
                    if(isLoggedIn) {
                        uk.gov.hmrc.cardpaymentfrontend.controllers.routes.SignOutController.timedOut.url
                    } else {
                        uk.gov.hmrc.cardpaymentfrontend.controllers.routes.TimeOutController.showForceDeleteAnswersLoggedOutPage.url
                    }
                ),
            keepAliveUrl = Some(uk.gov.hmrc.cardpaymentfrontend.controllers.routes.SignOutController.keepAlive.url),
            timeout = Some(appConfig.timeoutInSeconds),
            countdown = Some(appConfig.countdownInSeconds),
            title = None,
            message = Some { if (isLoggedIn) messages("time-out.dialogue.logged-in.message") else messages("time-out.dialogue.logged-out.message") },
            keepAliveButtonText = Some { if (isLoggedIn) messages("time-out.dialogue.logged-in.keep-alive-button-text") else messages("time-out.dialogue.logged-out.keep-alive-button-text") },
            signOutButtonText = Some { if (isLoggedIn) messages("time-out.dialogue.logged-in.sign-out-button-text") else messages("time-out.dialogue.logged-out.sign-out-button-text") }
        )
    }
}

@content = {
    @contentBlock
    @hmrcReportTechnicalIssueHelper()
}

@scripts = {
    @if(hideStyling) {
        @*Css file sets html elements within this page, loaded in iframe to display:none, essentially hiding, apart from a grey box for the iframe, better than seeing a weird partial hmrc page. *@
        @Html(s"""<link rel="stylesheet" media="all" type="text/css" href="${controllers.routes.Assets.versioned("stylesheets/redirect-to-parent-page.css").toString}">""")
    }
    @additionalScripts.getOrElse(Html(""))
}

@hmrcStandardPage(
  HmrcStandardPageParams(
      templateOverrides = TemplateOverrides(
          additionalScriptsBlock = Some(scripts),
          additionalHeadBlock = Some(headBlock)
      ),
      serviceURLs = ServiceURLs(
          signOutUrl = if (isLoggedIn) Some(uk.gov.hmrc.cardpaymentfrontend.controllers.routes.SignOutController.signOut.url) else None,
          serviceUrl = serviceUrl
      ),
      pageTitle = Some(journeyTitleMaker(h1Key = pageTitle, origin = origin, maybeForm = maybeForm)),
      serviceName = Some(serviceName),
      isWelshTranslationAvailable = welshSupported && welshSupportedForOrigin,
      backLink = {
          if (showBackLink) {
              if (backLinkOverride.isDefined) backLinkOverride else Some(BackLink.mimicsBrowserBackButtonViaJavaScript)
          } else None
      })
)(content)
